<HTML>
<TITLE>Technical overview : CeGCC (gcc) profiling and coverage support</TITLE>
<BODY>
<H1>Technical overview : CeGCC (gcc) profiling and coverage support</H1>
<P>
This document describes the way in which CeGCC
(and basically any gcc)
implements two sets of functionality :
<ul>
	<li>profiling
	<li>test coverage
</ul>
<P>
These are two related but different functionalities.
See the man pages of gprof and gcov for their description.
<H1>1. Overview</H1>
<P>
The tables below present an overview of how this all works,
the details are described further in this document.
<P>
The behaviour of the <b>arm-wince-cegcc-gcc</b> compiler :
<TABLE BORDER=1>
<TR>
	<TD><FONT COLOR="red">cegcc target</FONT></TD>
	<TD>Compiler option</TD>
	<TD>Startup files</TD>
	<TD>Startup calls</TD>
	<TD>Any source calls</TD>
	<TD>Exit calls (by atexit)</TD>
</TR>
<TR>
	<TD>Normal</TD>
	<TD> </TD>
	<TD>crt0.o crtst.o</TD>
	<TD>N/A</TD>
	<TD>N/A</TD>
	<TD>N/A</TD>
</TR>
<TR>
	<TD>Profiling</TD>
	<TD>-pg</TD>
	<TD>crt0.o crtst.o gcrt3.o</TD>
	<TD>monstartup</TD>
	<TD>mcount</TD>
	<TD>mcleanup</TD>
</TR>
<TR>
	<TD>Coverage</TD>
	<TD>--coverage</TD>
	<TD>crt0.o crtst.o</TD>
	<TD>N/A</TD>
	<TD>_gcov_init</TD>
	<TD>gcov_exit</TD>
</TR>
</TABLE>
<P>
The behaviour of the <b>arm-wince-mingw32ce-gcc</b> compiler :
<TABLE BORDER=1>
<TR>
	<TD><FONT COLOR="red">mingw32ce target</FONT></TD>
	<TD>Compiler option</TD>
	<TD>Startup files</TD>
	<TD>Startup calls</TD>
	<TD>Any source calls</TD>
	<TD>Exit calls (by atexit)</TD>
</TR>
<TR>
	<TD>Normal</TD>
	<TD> </TD>
	<TD>crt3.o</TD>
	<TD>N/A</TD>
	<TD>N/A</TD>
	<TD>N/A</TD>
</TR>
<TR>
	<TD>Profiling</TD>
	<TD>-pg</TD>
	<TD>crt3.o gcrt3.o</TD>
	<TD>monstartup</TD>
	<TD>mcount</TD>
	<TD>mcleanup</TD>
</TR>
<TR>
	<TD>Coverage</TD>
	<TD>--coverage</TD>
	<TD>crt3.o</TD>
	<TD>N/A</TD>
	<TD>_gcov_init</TD>
	<TD>gcov_exit</TD>
</TR>
</TABLE>
<H1>2. Profiling</H1>
<H2>2.1 Trigger by</H2>
gcc -pg
<H2>2.2 Tool options</H2>
<pre>
<b>dannypc: {94}</b> <i>arm-wince-cegcc-gcc -v -g -pg -o m1.cexe m1.co a.co b.co</i>
Using built-in specs.
Target: arm-wince-cegcc
Configured with: /home/danny/src/cegcc/svn.sf.net/cegcc/trunk/cegcc/src/gcc/configure \
 --with-gcc --with-gnu-ld --with-gnu-as --target=arm-wince-cegcc --prefix=/opt/cegcc \
 --enable-threads=win32 --disable-nls --enable-languages=c,c++ --disable-win32-registry \
 --disable-multilib --disable-interwork --without-newlib --enable-checking --with-headers
Thread model: win32
gcc version 4.1.0
 /opt/cegcc/libexec/gcc/arm-wince-cegcc/4.1.0/collect2 -Bdynamic -o m1.cexe \
 /opt/cegcc/lib/gcc/arm-wince-cegcc/4.1.0/../../../../arm-wince-cegcc/lib/crt0.o \
 /opt/cegcc/lib/gcc/arm-wince-cegcc/4.1.0/../../../../arm-wince-cegcc/lib/crtst.o \
 /opt/cegcc/lib/gcc/arm-wince-cegcc/4.1.0/../../../../arm-wince-cegcc/lib/gcrt3.o \
 -L/opt/cegcc/lib/gcc/arm-wince-cegcc/4.1.0 -L/opt/cegcc/lib/gcc/arm-wince-cegcc/4.1.0/../../../../arm-wince-cegcc/lib \
 m1.co a.co b.co -lcegcc -lgcc -lgmon -lcoredll -lcegcc -lgcc
 Info: resolving _CRT_MT by linking to __imp__CRT_MT (auto-import)
</pre>
<H2>2.3 What's where</H2>
<H3>2.3.1 crt0.o</H3>
<pre>
00000000 b .bss
00000000 d .data
00000000 p .pdata
00000000 t .text
00000008 T WinMainCRTStartup
00000034 t _PMyMain
00000030 t _PStartup
0000002c t _P__set_runtime_thread_mode
00000008 T __EH_CODE_START__
00000000 T __EH_HANDLER__
         U __set_runtime_thread_mode
	 U _eh_handler
00000008 T _mainCRTStartup
	 U _startup
         U main
</pre>
<H3>2.3.2 crtst.o</H3>
<pre>
00000000 b .bss
00000000 d .data
00000000 t .text
         U _CRT_MT
00000000 T __set_runtime_thread_mode
</pre>
<H3>2.3.3 gcrt3.o</H3>
<P>
The source of <i>gcrt3.o</i> is in <i>src/mingw/profile/gcrt0.c</i>.
It provides for the function <b>_monstartup</b> whose purpose is
to call <b>monstartup</b> and register <b>_mcleanup</b>
as an exit handler via <b>atexit</b>.
<P>
Both <b>_mcleanup</b> and <b>monstartup</b> are in <b>libgmon.a</b>,
their source is <i>src/mingw/profile/gmon.c</i>.
<P>
<pre>
00000000 b .bss
00000000 t .ctors
00000000 d .data
00000000 t .text
00000064 t __eprol
         U _mcleanup
00000000 T _monstartup
         U atexit
00000000 b called.1802
         U etext
         U monstartup
</pre>
<H3>2.3.4 -lgmon</H3>
<pre>
gmon.o:
00000000 b .bss
00000000 d .data
00000000 r .rdata
00000000 t .text
         U FormatMessageW
         U GetLastError
         U GetModuleFileNameW
         U MessageBoxW
         U __addsf3
         U __divsf3
         U __fixsfsi
         U __floatsisf
         U __mulsf3
         U __udivsi3
00000000 D _gmonparam
00000354 T _mcleanup
         U bzero
00000000 t fake_sbrk
         U fclose
         U fopen
         U fwrite
         U malloc
000006bc T moncontrol
0000002c T monstartup
         U profil
00000000 b s_scale
         U wcstombs

mcount.o:
00000000 b .bss
00000000 d .data
00000000 t .text
         U __udivsi3
         U _gmonparam
00000334 T _mcount
00000000 T mcount_internal

profil.o:
00000000 b .bss
00000000 d .data
00000000 t .text
         U CloseHandle
         U CreateThread
         U DuplicateHandle
         U GetThreadContext
         U ResumeThread
         U SetThreadPriority
         U Sleep
         U SuspendThread
         U TerminateThread
         U __udivdi3
00000000 t get_thrpc
         U memset
00000000 b prof
00000418 T profil
000002f4 T profile_ctl
0000018c t profile_off
00000200 t profile_on
00000090 t profthr_func
</pre>
<H1>3. Coverage support</H1>
<H2>3.1 </H2>
<pre>
dannypc: {55} arm-wince-cegcc-gcc -g -fprofile-arcs -ftest-coverage -o m1.cexe m1.co a.co b.co -v
Using built-in specs.
Target: arm-wince-cegcc
Configured with: /home/danny/src/cegcc/svn.sf.net/cegcc/trunk/cegcc/src/gcc/configure --with-gcc --with-gnu-ld --with-gnu-as --target=arm-wince-cegcc --prefix=/opt/cegcc --enable-threads=win32 --disable-nls --enable-languages=c,c++ --disable-win32-registry --disable-multilib --disable-interwork --without-newlib --enable-checking --with-headers
Thread model: win32
gcc version 4.1.0
 /opt/cegcc/libexec/gcc/arm-wince-cegcc/4.1.0/collect2 -Bdynamic -o m1.cexe /opt/cegcc/lib/gcc/arm-wince-cegcc/4.1.0/../../../../arm-wince-cegcc/lib/crt0.o /opt/cegcc/lib/gcc/arm-wince-cegcc/4.1.0/../../../../arm-wince-cegcc/lib/crtst.o -L/opt/cegcc/lib/gcc/arm-wince-cegcc/4.1.0 -L/opt/cegcc/lib/gcc/arm-wince-cegcc/4.1.0/../../../../arm-wince-cegcc/lib m1.co a.co b.co -lgcov -lcegcc -lgcc -lcoredll -lcegcc -lgcc
Info: resolving _CRT_MT by linking to __imp__CRT_MT (auto-import)

</pre>
<H2>3.2 </H2>
<pre>
dannypc: {56} arm-wince-cegcc-nm m1.co
00000000 b .bss
00000000 t .ctors
00000000 d .data
00000000 N .debug_abbrev
00000000 N .debug_aranges
00000000 N .debug_frame
00000000 N .debug_info
00000000 N .debug_line
00000000 N .debug_loc
00000000 N .debug_pubnames
00000000 N .debug_str
00000000 r .rdata
00000000 t .text
00000140 t _GLOBAL__I_0_main
         U __gccmain
         U __gcov_init
         U __gcov_merge_add
         U func_a
         U func_b
00000000 T main
</pre>
<H2>3.3 libgcov.a</H2>
<pre>
dannypc: {71} arm-wince-cegcc-nm  /opt/cegcc/lib/gcc/arm-wince-cegcc/4.1.0/libgcov.a

_gcov.o:
00000000 b .bss
00000000 d .data
00000000 N .debug_abbrev
00000000 N .debug_aranges
00000000 N .debug_frame
00000000 N .debug_info
00000000 N .debug_line
00000000 N .debug_loc
00000000 N .debug_pubnames
00000000 N .debug_ranges
00000000 N .debug_str
00000000 r .rdata
00000000 t .text
         U MessageBoxW
00000428 T __gcov_close
000011fc T __gcov_flush
0000009c T __gcov_init
00000484 T __gcov_open
0000053c T __gcov_read_counter
00000580 T __gcov_read_summary
0000051c T __gcov_read_unsigned
000001dc T __gcov_seek
00001020 C __gcov_var
000002d0 T __gcov_write_counter
00000304 T __gcov_write_summary
000002b0 T __gcov_write_tag_length
000002ec T __gcov_write_unsigned
         U __getreent
         U abort
         U atexit
         U atoi
         U fclose
         U fopen
         U fprintf
         U fread
         U fseek
         U ftell
         U fwrite
00000008 b gcov_crc32
000005cc t gcov_exit
00000004 b gcov_list
00000000 b gcov_max_filename
00000358 t gcov_read_words
00000000 t gcov_version
00000190 t gcov_write_block
0000022c t gcov_write_words
         U getenv
         U memcmp
         U memcpy
         U memset
         U setbuf
         U strcpy
         U strlen

_gcov_merge_add.o:
00000000 b .bss
00000000 d .data
00000000 N .debug_abbrev
00000000 N .debug_aranges
00000000 N .debug_frame
00000000 N .debug_info
00000000 N .debug_line
00000000 N .debug_pubnames
00000000 N .debug_str
00000000 t .text
00000000 T __gcov_merge_add

_gcov_merge_single.o:
00000000 b .bss
00000000 d .data
00000000 N .debug_abbrev
00000000 N .debug_aranges
00000000 N .debug_frame
00000000 N .debug_info
00000000 N .debug_line
00000000 N .debug_pubnames
00000000 N .debug_str
00000000 t .text
00000000 T __gcov_merge_single

_gcov_merge_delta.o:
00000000 b .bss
00000000 d .data
00000000 N .debug_abbrev
00000000 N .debug_aranges
00000000 N .debug_frame
00000000 N .debug_info
00000000 N .debug_line
00000000 N .debug_pubnames
00000000 N .debug_str
00000000 t .text
00000000 T __gcov_merge_delta

_gcov_fork.o:
00000000 b .bss
00000000 d .data
00000000 N .debug_abbrev
00000000 N .debug_info
00000000 N .debug_line
00000000 N .debug_str
00000000 t .text

_gcov_execl.o:
00000000 b .bss
00000000 d .data
00000000 N .debug_abbrev
00000000 N .debug_info
00000000 N .debug_line
00000000 N .debug_str
00000000 t .text

_gcov_execlp.o:
00000000 b .bss
00000000 d .data
00000000 N .debug_abbrev
00000000 N .debug_info
00000000 N .debug_line
00000000 N .debug_str
00000000 t .text

_gcov_execle.o:
00000000 b .bss
00000000 d .data
00000000 N .debug_abbrev
00000000 N .debug_info
00000000 N .debug_line
00000000 N .debug_str
00000000 t .text

_gcov_execv.o:
00000000 b .bss
00000000 d .data
00000000 N .debug_abbrev
00000000 N .debug_info
00000000 N .debug_line
00000000 N .debug_str
00000000 t .text

_gcov_execvp.o:
00000000 b .bss
00000000 d .data
00000000 N .debug_abbrev
00000000 N .debug_info
00000000 N .debug_line
00000000 N .debug_str
00000000 t .text

_gcov_execve.o:
00000000 b .bss
00000000 d .data
00000000 N .debug_abbrev
00000000 N .debug_info
00000000 N .debug_line
00000000 N .debug_str
00000000 t .text

_gcov_interval_profiler.o:
00000000 b .bss
00000000 d .data
00000000 N .debug_abbrev
00000000 N .debug_info
00000000 N .debug_line
00000000 N .debug_str
00000000 t .text

_gcov_pow2_profiler.o:
00000000 b .bss
00000000 d .data
00000000 N .debug_abbrev
00000000 N .debug_info
00000000 N .debug_line
00000000 N .debug_str
00000000 t .text

_gcov_one_value_profiler.o:
00000000 b .bss
00000000 d .data
00000000 N .debug_abbrev
00000000 N .debug_info
00000000 N .debug_line
00000000 N .debug_str
00000000 t .text
dannypc: {72} 
</pre>
<H1>4. Normal linkage</H1>
<pre>
dannypc: {15} arm-wince-cegcc-gcc -v -c d.c
Using built-in specs.
Target: arm-wince-cegcc
Configured with: /home/danny/src/cegcc/svn.sf.net/cegcc/trunk/cegcc/src/gcc/configure --with-gcc --with-gnu-ld --with-gnu-as --target=arm-wince-cegcc --prefix=/opt/cegcc --enable-threads=win32 --disable-nls --enable-languages=c,c++ --disable-win32-registry --disable-multilib --disable-interwork --without-newlib --enable-checking --with-headers
Thread model: win32
gcc version 4.1.0
 /opt/cegcc/libexec/gcc/arm-wince-cegcc/4.1.0/cc1 -quiet -v -D__CEGCC32__ -D__CEGCC__ -Dunix -D__unix__ -D__unix -idirafter /opt/cegcc/lib/gcc/arm-wince-cegcc/4.1.0/../../../../arm-wince-cegcc/lib/../include/w32api -idirafter ../../include/w32api d.c -quiet -dumpbase d.c -auxbase d -version -o /home/danny/tmp/cctFcZE7.s
ignoring nonexistent directory "/opt/cegcc/lib/gcc/arm-wince-cegcc/4.1.0/../../../../arm-wince-cegcc/sys-include"
ignoring nonexistent directory "../../include/w32api"
#include "..." search starts here:
#include <...> search starts here:
 /opt/cegcc/lib/gcc/arm-wince-cegcc/4.1.0/include
 /opt/cegcc/lib/gcc/arm-wince-cegcc/4.1.0/../../../../arm-wince-cegcc/include
 /opt/cegcc/lib/gcc/arm-wince-cegcc/4.1.0/../../../../arm-wince-cegcc/lib/../include/w32api
End of search list.
GNU C version 4.1.0 (arm-wince-cegcc)
        compiled by GNU C version 4.0.1 (4.0.1-5mdk for Mandriva Linux release 2006.0).
GGC heuristics: --param ggc-min-expand=30 --param ggc-min-heapsize=4096
Compiler executable checksum: 17d7394c32aee3aebff6a808e8a7d8ad
 /opt/cegcc/lib/gcc/arm-wince-cegcc/4.1.0/../../../../arm-wince-cegcc/bin/as -o d.o /home/danny/tmp/cctFcZE7.s
dannypc: {16} arm-wince-cegcc-gcc -v -o d.exe d.o
Using built-in specs.
Target: arm-wince-cegcc
Configured with: /home/danny/src/cegcc/svn.sf.net/cegcc/trunk/cegcc/src/gcc/configure --with-gcc --with-gnu-ld --with-gnu-as --target=arm-wince-cegcc --prefix=/opt/cegcc --enable-threads=win32 --disable-nls --enable-languages=c,c++ --disable-win32-registry --disable-multilib --disable-interwork --without-newlib --enable-checking --with-headers
Thread model: win32
gcc version 4.1.0
 /opt/cegcc/libexec/gcc/arm-wince-cegcc/4.1.0/collect2 -Bdynamic -o d.exe /opt/cegcc/lib/gcc/arm-wince-cegcc/4.1.0/../../../../arm-wince-cegcc/lib/crt0.o /opt/cegcc/lib/gcc/arm-wince-cegcc/4.1.0/../../../../arm-wince-cegcc/lib/crtst.o -L/opt/cegcc/lib/gcc/arm-wince-cegcc/4.1.0 -L/opt/cegcc/lib/gcc/arm-wince-cegcc/4.1.0/../../../../arm-wince-cegcc/lib d.o -lcegcc -lgcc -lcoredll -lcegcc -lgcc
Info: resolving _CRT_MT by linking to __imp__CRT_MT (auto-import)
</pre>
<H2>
<H1>5. Ways in which WinCE applications start and terminate</H1>
<H2>5.1 Startup</H2>
<H3>5.1.1 main</H3>
<P>
<b>main</b> is the entry point for C language programs in college textbooks,
it's also the default entry point generated by cegcc.
<i>crt0.o</i> will call <b>main</b>.
<H3>5.1.2 WinMain</H3>
<P>
The normal startup for an application with a GUI (graphical user interface)
on a Windows platform is <b>WinMain</b>.
CeGCC implements that through the <i>main.o</i> module in <b>libc.a</b> or <b>libcegcc.dll</b>.
<P>
The <b>main.o</b> module defines a <i>main</i> function which calls <i>WinMain</i>.
To figure out the parameters for that function,
it calls a number of WinCE functions such as <i>GetCommandLineW</i>.
When you compile a program that has a <i>main</i> function of its own
(see the previous paragraph), the main.o is simply not used.
The source for <i>main.o</i> is in <b>src/newlib/newlib/libc/sys/wince/main.c</b>.
<H2>5.2 Termination</H2>
<H3>5.2.1 WinMain PostQuitMessage</H3>
<H3>5.2.2 WinMain fall through</H3>
<H3>5.2.3 WinMain WM_DESTROY</H3>
<H3>5.2.4 exit</H3>
<H3>5.2.5 main fall through</H3>
</BODY>
</HTML>
